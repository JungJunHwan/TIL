# 자바 메모리 구조

## Metaspace 영역

### Metaspace란?

- 클래스의 메타데이터가 저장되는 영역
- JVM이 로딩한 클래스 정보(클래스의 구조, 메서드, 필드, 상속 관계 등)기 저장되는 공간
- 자바 7 이전에는 이 영역이 Permanent Generation(PermGen)이라 불렸다
- 하지만 PermGen에는 문제가 있었다
    - 크기 고정
        - JVM 시작 시 크기가 고정되어 런타임 중에 클래스가 많이 로드되면 `OutOfMemoryError: PermGen Space`가 자주 발생
    - 비효율적인 GC
        - 클래스 언로드가 일어나도 PermGen 내부 메모리를 JVM이 잘 회수하지 못했다
    - 네이티브 코드와의 불일치
        - PermGen은 힙 영역 내부에 있었기 때문에, OS의 네이티브 메모리와 연동이 비효율적이었다
- 따라서 자바 8부터 PermGen이 제거되고 Metaspace로 대체되었다

### Metaspace의 특징

| 항목 | 설명 |
| :-- | :-- |
| 저장 위치 | 네이티브 메모리(native memory) 에 존재 (즉, 힙 밖에 있음) |
| 저장 내용 | 클래스의 메타데이터 (클래스명, 메서드, 필드, 상속, 인터페이스, 어노테이션 등) |
| GC 관리 여부 | JVM이 GC를 통해 더 이상 사용되지 않는 클래스의 메타데이터를 해제할 수 있음 |
| 크기 조정 | OS 메모리 상황에 따라 자동으로 확장 가능 (기본 제한은 없음, 단 `-XX:MaxMetaspaceSize` 옵션으로 상한 설정 가능) |
| 장점 | 자동 확장, PermGen의 고정된 크기 문제 해결, OutOfMemory 발생률 감소 |

### Metaspace에 저장되는 것들

- 클래스 이름
- 상속 관계 (extends, implements)
- 필드 정보 (타입, 접근제어자 등)
- 메서드 시그니처 및 바이트 코드
- Static variable의 레퍼런스
- Runtime Constant Pool
- 어노테이션 메타데이터

### 관련 JVM 옵션

| 옵션 | 설명 |
| :-- | :-- |
| `-XX:MetaspaceSize=256m` | Metaspace의 **초기 크기** (GC가 처음 동작하는 임계값) |
| `-XX:MaxMetaspaceSize=512m` | Metaspace의 **최대 크기** (이걸 넘으면 `OutOfMemoryError: Metaspace`) |
| `-XX:MinMetaspaceFreeRatio` | GC 후 남아있을 최소 여유 공간 비율 |
| `-XX:MaxMetaspaceFreeRatio` | GC 후 남아있을 최대 여유 공간 비율 |
