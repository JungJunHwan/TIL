# 자바 메모리 구조

## 스택(Stack) 영역

### 스택이란?

- 메서드가 실행될 때마다 임시로 필요한 메모리 공간을 제공하는 영역
- 힙은 new로 만들고 GC가 정리하지만, 스택은 자동으로 관리되어 메서드가 끝나느 순간 그 안의 모든 변수가 사라진다

### 스택에 저장되는 것

- 기본형 변수
- 참조형 변수의 주소값 (힙 객체의 위치)
- 메서드 호출 정보 (리턴 위치 등)

### 스택 프레임의 내부 구성

| 구성 요소 | 설명 |
| --- | --- |
| 로컬 변수 테이블(Local Variable Array) | 메서드의 매개변수와 지역 변수를 저장 |
| 오퍼랜드 스택(Operand Stack) | 연산 과정 중 임시로 사용하는 계산용 스택 |
| 프레임 데이터(Frame Data) | 메서드와 클래스의 메타정보, 예외 테이블, 리턴 주소 등 |


#### 로컬 변수 테이블

- 메서드 안의 모든 지역 변수와 매게변수가 저장된다
- 배열처럼 인덱스로 관리된다
    - 각 변수마다 한 칸의 슬롯이 고정적으로 배정돼 있고, 이 안에는 값 자체나 참조 주소가 들어간다
    - 각 슬롯은 32비트(= 4바이트)
- 정수형(int, float) 등은 값 자체가 저장된다
    - long, double은 64비트라서 슬롯 2개를 차지한다
- 참조형(String, Object)은 힙 객체의 주소가 저장된다

#### 오퍼랜드 스택

- 연산용 스택이며, 바이트코드 실행 중 계산할 때 잠깐 쓰이는 임시 저장소다
- 명령어 간 값 전달용 버퍼라고 보면 된다

#### 프레임 데이터
- 메타적인 정보이다
    - 메타는 어떤 대상 그 자체가 아니라, 그 대상을 설명하거나 관리하는 정보라는 뜻
    - 데이터 그 자체가 아니라, 데이터를 해석하기 위한 부가 설명
- 프로그래머가 못 건드리지만 JVM이 내부적으로 호출 흐름을 추적하기 위해 꼭 필요한 정보들이다

| 항목 | 역할 |
| --- | --- |
| 리턴 주소(Return Address) | 이 메서드가 끝난 뒤 어디로 돌아갈지 |
| 메서드 참조(Method Reference) | 어떤 클래스의 어떤 메서드인지 |
| 예외 테이블(try-catch map) | 예외 발생 시 점프할 위치 정보 |
| 상수 풀(Constant Pool) 참조 | 바이트코드에서 상수 값 조회 시 사용 |

### 스택 프레임 전체 구조 예시

```css
┌──────────────────────────┐ ← 스택의 top (가장 최근 호출된 메서드)
│ Operand Stack            │ ← 계산 중간 결과
│ [a, b]                   │
│ [a+b]                    │
├──────────────────────────┤
│ Local Variable Table     │ ← 지역 변수, 매개변수
│ slot 0: this             │
│ slot 1: a = 10           │
│ slot 2: b = 20           │
│ slot 3: c = 30           │
├──────────────────────────┤
│ Frame Data               │ ← 메서드 메타, 리턴주소, 예외테이블
└──────────────────────────┘
```

- 이 구조 하나가 스택 프레임이고, 메서드를 호출할 때마다 이런 프레임이 하나씩 쌓인다

### 스택에 없는 것

| 항목 | 이유 |
| --- | --- |
| 객체 필드 값 | 객체 본체는 힙에 저장됨 |
| 배열 요소 | 배열도 힙에 있음 |
| static 변수 | 클래스 메서드 영역(Method Area)에 저장됨 |
| GC로 수거되는 객체 | 힙 영역의 일 |

### 정리

**스택에는 각 메서드별로 하나의 스택 프레임이 있고, 그 안에는 로컬 변수, 연산용 스택, 메타정보가 있다.
메서드가 끝나면 프레임 전체가 사라져서 안에 있던 데이터도 전부 사라진다**